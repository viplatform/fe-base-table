name: Dastardly
on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  scan:
    permissions:
      contents: write
      pull-requests: write
      checks: write
    name: Dastardly
    #runs-on: ubuntu-latest
    runs-on: 
        labels: [self-hosted,dev-image-builder]
    steps:
      - name: Run Dastardly Action Step
        continue-on-error: true                        # This allows subsequent steps to run even if this step fails
        uses: PortSwigger/dastardly-github-action@main
        with:
          target-url: 'https://storybook.viplatform.net'
          
  # You can replace this next step with any JUnit XML parser of your choosing
      - name: Publish Test Report
        if: always()                                    # Forces this step to always run
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: '**/dastardly-report.xml'       # You need to update this path if you pass in a different output filename to the Dastardly action
        #  token: ${{ secrets.GH_PAT }}
          require_tests: true
          include_passed: true

      - name: Notify Test Report to Slack
        uses: viplatform/xunit-slack-reporter@main
        env:
          ONLY_NOTIFY_ON_ISSUES: "False"
          SLACK_CHANNEL: C05AF97SLR4
          SLACK_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          XUNIT_PATH: ./dastardly-report.xml
